<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Grafo</title>
</head>
<body>
    <h1>Crear Grafo en movimiento</h1>
    <p id="status">Esperando ubicaci√≥n...</p>
    <p id="distancia">Distancia recorrida: 0 cm</p>

    <script>
        let ultimaLat = null, ultimaLon = null;
        let distanciaTotal = 0;
        const umbral = 5; // Umbral de 5 cm para detectar movimiento
        const tiempoMinimoMovimiento = 2000; // 2 segundos entre verificaciones

        let tiempoUltimaVerificacion = 0;

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const rad = Math.PI / 180;

            const dLat = (lat2 - lat1) * rad;
            const dLon = (lon2 - lon1) * rad;

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * rad) * Math.cos(lat2 * rad) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distanciaMetros = R * c; // Resultado en metros
            return distanciaMetros * 100; // Convertimos a cent√≠metros
        }

        function iniciarSeguimiento() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    function (position) {
                        let lat = position.coords.latitude;
                        let lon = position.coords.longitude;
                        let accuracy = position.coords.accuracy;

                        if (accuracy > 100) {
                            console.warn("‚ö†Ô∏è Ubicaci√≥n poco precisa, ignorada.");
                            return;
                        }

                        document.getElementById("status").innerText = `üìç Ubicaci√≥n: ${lat}, ${lon} (¬±${accuracy.toFixed(1)}m)`;

                        // Verifica si ha pasado el tiempo m√≠nimo antes de comprobar el movimiento
                        let ahora = new Date().getTime();
                        if (ahora - tiempoUltimaVerificacion >= tiempoMinimoMovimiento) {
                            if (ultimaLat !== null && ultimaLon !== null) {
                                let distanciaCM = calcularDistancia(ultimaLat, ultimaLon, lat, lon);

                                // Si la distancia recorrida es mayor que el umbral, est√° en movimiento
                                if (distanciaCM > umbral) {
                                    console.log("üö∂‚Äç‚ôÇÔ∏è El tel√©fono est√° en movimiento.");
                                    document.getElementById("status").innerText = `üìç El tel√©fono se est√° moviendo: ${lat}, ${lon} (¬±${accuracy.toFixed(1)}m)`;
                                } else {
                                    console.log("üõë El tel√©fono est√° detenido.");
                                    document.getElementById("status").innerText = `üõë El tel√©fono est√° detenido: ${lat}, ${lon} (¬±${accuracy.toFixed(1)}m)`;
                                }

                                // Solo actualizamos la distancia si la distancia recorrida es mayor que el umbral
                                distanciaTotal += distanciaCM;
                                document.getElementById("distancia").innerText = `Distancia recorrida: ${distanciaTotal.toFixed(2)} cm`;
                            }

                            // Actualiza las √∫ltimas coordenadas y la hora de la √∫ltima verificaci√≥n
                            ultimaLat = lat;
                            ultimaLon = lon;
                            tiempoUltimaVerificacion = ahora;
                        }
                    },
                    function (error) {
                        console.error("‚ùå Error de geolocalizaci√≥n:", error.message);
                        document.getElementById("status").innerText = "‚ùå No se pudo obtener la ubicaci√≥n.";
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("‚ùå Tu navegador no soporta geolocalizaci√≥n.");
            }
        }

        function enviarDatos() {
            if (ultimaLat !== null && ultimaLon !== null) {
                fetch(`http://192.168.3.13:5000/coordenadas?lat=${ultimaLat}&lon=${ultimaLon}`)
                    .then(response => response.json())
                    .then(data => console.log("üì© Respuesta del servidor:", data))
                    .catch(error => console.error("‚ùå Error al enviar datos:", error));
            }
        }

        iniciarSeguimiento(); // Iniciar la ubicaci√≥n en tiempo real autom√°ticamente
        setInterval(enviarDatos, 3000);
    </script>
</body>
</html>